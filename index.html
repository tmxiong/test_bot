<!DOCTYPE html>
<html>

<head>
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>test bot</title>
</head>

<script src="http://libs.baidu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/ethers/4.0.49/ethers.min.js" charset="utf-8" type="text/javascript"></script>
<!--FileSaver来源：https://www.bootcdn.cn/FileSaver.js/-->
<script src="https://cdn.bootcdn.net/ajax/libs/FileSaver.js/2.0.5/FileSaver.js"></script>

<body style="background-color: #a2e6ff">

<div>
    <div>
        <p>KeyStore导出</p>
        <p>密码: <input type="text" id="password"></p>
        <p>钱包地址: <span id="address"></span></p>
        <p style="color: deepskyblue;"><span id="message"></span></p>

        <div>
            <button type="button" onclick="save_keystore()" ;> 创建钱包 </button>
        </div>
    </div>

    <HR align=center width=100% color=#987cb9 SIZE=1 style="margin: 40px 0">

    <div>
        <p>加载KeyStore文件</p>
        <p>KeyStore:<input type="file" id="select_wallet_file" /></p>
        <p>密码: <input type="text" id="recovery_password"></p>

        <p>钱包地址: <span id="recovery_address"></span></p>
        <p>私钥: <span id="recovery_privateKey"></span></p>
        <p>
            <span style="color: deepskyblue;" id="recovery_message"></span>
            <span style="color: red;" id="recovery_error"></span>
        </p>
        <div>
            <button type="button" onclick="select_submit_wallet()" ;> 获取私钥 </button>
        </div>
    </div>

    <HR align=center width=100% color=#987cb9 SIZE=1 style="margin: 40px 0">
    <div>

        <div>
            <button type="button" onclick="getBlocks()">获取最新区块</button>
        </div>
        <ul id="block">
        </ul>
    </div>

</div>

<script type="text/javascript">
    function save_keystore() {
        const password = $("#password").val()
        const privateKey = ethers.utils.randomBytes(32);
        const wallet = new ethers.Wallet(privateKey);
        $('#address').html(wallet.address)
        $('#message').html('文件保存中...')

        wallet.encrypt(password).then(function (json) {
            const blob = new Blob([json], { type: "text/plain;charset=utf-8" });
            $('#message').html('文件保存成功！')
            // 使用了FileSaver.js 进行文件保存
            saveAs(blob, "keystore.json");
        })
    }

    function select_submit_wallet() {
        const password = $("#recovery_password").val()
        const fileReader = new FileReader();
        const inputFile = document.getElementById('select_wallet_file')
        const file = inputFile.files[0];
        fileReader.readAsText(file);
        fileReader.onload = function (e) {
            var json = e.target.result;
            $('#recovery_message').html('正在加载KeyStore文件...')
            ethers.Wallet.fromEncryptedJson(json, password).then(function (wallet) {
                $('#recovery_message').html('加载KeyStore文件成功')
                $('#recovery_address').html(wallet.address)
                $('#recovery_privateKey').html(wallet.privateKey)
            }, function (error) {
                $('#recovery_error').html(error)
            });
        };
    }
    async function getBlocks() {
        $('#block').empty();
        // 配置以太坊节点
        const provider = new ethers.providers.JsonRpcProvider('https://mainnet.infura.io/v3/8db3eb66565d4cb3b38066cef37a9247');
        // 获取最新的区块号
        provider.getBlockNumber().then(latestBlockNumber => {
            console.log(`Latest block number: ${latestBlockNumber}`);
            var str = ''
            // 查询最新的 10 个区块的信息
            for (let i = 0; i < 10; i++) {
                const blockNumber = latestBlockNumber - i;
                provider.getBlock(blockNumber).then(block => {
                    console.log(`Block ${blockNumber}:`, block);
                    str += `<li>${blockNumber}</li>`
                    if(i == 9) {
                        $('#block').html(str);
                    }
                }).catch(error => {
                    console.error(`Error fetching block ${blockNumber}:`, error);
                });
            }
        });
    }
</script>

</html>
</body>

</html>
